<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buckshot Counter</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
    body { 
        margin: 0; padding: 0; min-height: 100vh; color: #d1d1d1; 
        font-family: 'Courier Prime', 'Courier New', monospace; 
        text-align: center; background: url('buckshot.png');
        background-size: cover; background-position: center; background-attachment: fixed; 
        background-color: #000; display: flex; flex-direction: column; align-items: center;
    }

    .main-ui { width: 100%; max-width: 800px; padding-top: 40px; z-index: 5; }

    h1 { 
        font-family: 'Bebas Neue', sans-serif; color: #8b0000; font-size: 5rem; 
        letter-spacing: 12px; text-shadow: 4px 4px 6px #000; margin: 0 0 10px 0;
        text-transform: uppercase;
    }

    .stage { display: none; }
    .stage.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* 設定畫面 */
    .setup-area { margin-top: 50px; }
    .setup-title { color: #d4af37; font-family: 'Bebas Neue'; font-size: 1.8rem; margin-bottom: 30px; text-shadow: 2px 2px 2px #000; }

    .ammo-row { display: flex; align-items: center; justify-content: center; margin: 25px 0; gap: 30px; }
    
    .bullet-icon {
        width: 60px; height: 32px; position: relative;
        border-radius: 4px 15px 15px 4px;
        background: #111; border: 1px solid #333;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.8);
    }
    .bullet-icon::before {
        content: ''; position: absolute; left: 0; top: 0; width: 18px; height: 100%;
        background: linear-gradient(to bottom, #443311, #aa8844 50%, #443311);
        border-right: 1px solid #222; border-radius: 4px 0 0 4px;
    }
    .bullet-icon.live {
        background: repeating-linear-gradient(45deg, #700, #800 2px, #900 4px);
        border-color: #500;
    }
    .bullet-icon.blank {
        background: repeating-linear-gradient(45deg, #1a3a5a, #204060 2px, #2a4a6a 4px);
        border-color: #2a4a6a;
    }

    /* 戰鬥畫面的剩餘彈藥小圖示 */
    .rem-bullet-list { display: flex; gap: 8px; justify-content: center; margin: 10px 0; min-height: 25px; }
    .bullet-sm {
        width: 35px; height: 18px; position: relative;
        border-radius: 2px 8px 8px 2px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .bullet-sm::before {
        content: ''; position: absolute; left: 0; top: 0; width: 10px; height: 100%;
        background: linear-gradient(to bottom, #443311, #aa8844 50%, #443311);
        border-radius: 2px 0 0 2px;
    }
    .bullet-sm.live { background: #8b0000; border-color: #ff0000; }
    .bullet-sm.blank { background: #1a4a8a; border-color: #3a8aff; }

    .ammo-grid { display: flex; gap: 10px; }
    
    .ammo-slot {
        width: 45px; height: 60px; border: 2px solid #444; background: rgba(0,0,0,0.6);
        color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-family: 'Bebas Neue'; font-size: 1.6rem; transition: 0.1s;
        border-radius: 4px;
    }
    
    .ammo-slot.live-selected { 
        background: #8b0000; color: #fff; border-color: #ff4444; 
        box-shadow: 0 0 10px rgba(255,0,0,0.3), inset 0 0 10px #000;
    }
    .ammo-slot.blank-selected { 
        background: #1a4a8a; color: #fff; border-color: #3a8aff; 
        box-shadow: 0 0 12px rgba(58,138,255,0.4), inset 0 0 10px #000;
    }
    
    .action-btn { 
        background: transparent; border: 2px solid #d4af37; color: #d4af37; 
        margin-top: 50px; padding: 12px 45px; cursor: pointer; 
        font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 3px;
        text-shadow: 2px 2px 2px #000; transition: 0.2s;
    }
    .action-btn:hover:not(.invalid) { background: #d4af37; color: #000; box-shadow: 0 0 20px rgba(212,175,55,0.4); }
    .action-btn.invalid { border-color: #444; color: #444; cursor: not-allowed; opacity: 0.5; }

    /* 戰鬥畫面 */
    .shell-container { display: flex; justify-content: center; gap: 12px; margin: 35px auto; flex-wrap: wrap; }
    .shell {
        width: 65px; height: 35px; border: 1px solid #333; border-radius: 4px 12px 12px 4px;
        background: #1a1a1a; cursor: pointer; display: flex; align-items: center;
        justify-content: center; font-size: 18px; transition: 0.2s;
        position: relative; color: #444; font-family: 'Bebas Neue', sans-serif;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    }
    .shell::before {
        content: ''; position: absolute; left: 0; width: 16px; height: 100%;
        background: #443311; border-radius: 4px 0 0 4px; opacity: 0.6;
    }

    .shell.current { 
        border: 2px solid #d4af37; 
        transform: scale(1.15); 
        z-index: 10; 
        animation: yellowBreathing 4s ease-in-out infinite; 
    }
    
    @keyframes yellowBreathing {
        0%, 100% { box-shadow: 0 0 8px rgba(212,175,55,0.4); border-color: #d4af37; }
        50% { box-shadow: 0 0 35px rgba(212,175,55,0.8), 0 0 10px #fff; border-color: #fff; }
    }

    .shell.live { background: #8b0000; border-color: #ff0000; color: #fff; }
    .shell.live::before { background: #aa8844; opacity: 1; }
    
    .shell.blank { background: #1a4a8a; border-color: #3a8aff; color: #fff; }
    .shell.blank::before { background: #666; opacity: 1; }
    
    .track-controls { margin: 20px 0; display: flex; justify-content: center; gap: 25px; align-items: center; }
    .nav-btn { background: rgba(0,0,0,0.5); color: #d4af37; border: 1px solid #d4af37; padding: 5px 20px; cursor: pointer; font-family: 'Bebas Neue'; font-size: 1.5rem; }
    
    .shot-display { 
        font-family: 'Bebas Neue'; letter-spacing: 4px; color: #8b0000; font-size: 2.8rem;
        text-shadow: 2px 2px 4px #000;
    }

    .highlight { 
        font-weight: bold; color: #8b0000; font-size: 4rem; 
        text-shadow: 0 0 15px rgba(139,0,0,0.6); 
    }

    .status-panel { margin-top: 20px; font-family: 'Bebas Neue'; }

    /* 底部按鈕區 */
    .footer-btns { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
    .footer-btn { 
        background: transparent; border: 2px solid #444; color: #888; 
        padding: 8px 25px; cursor: pointer; font-family: 'Bebas Neue'; 
        font-size: 1.2rem; transition: 0.2s;
    }
    .footer-btn:hover { border-color: #d4af37; color: #d4af37; }
    .footer-btn.reset-btn:hover { border-color: #ff4444; color: #ff4444; }

</style>
</head>
<body>

    <div class="main-ui">
        <h1>High Roller</h1>

        <div id="setup-stage" class="stage active">
            <div class="setup-area">
                <div class="setup-title">彈藥數量</div>
                
                <div class="ammo-row">
                    <div class="bullet-icon live"></div>
                    <div class="ammo-grid" id="live-selector"></div>
                </div>

                <div class="ammo-row">
                    <div class="bullet-icon blank"></div>
                    <div class="ammo-grid" id="blank-selector"></div>
                </div>

                <button id="start-btn" class="action-btn invalid" onclick="startCombat()">Shootin' dice with Jesus Christ</button>
            </div>
        </div>

        <div id="combat-stage" class="stage">
            <div class="shell-container" id="shell-track"></div>
            
            <div class="track-controls">
                <button class="nav-btn" onclick="movePointer(-1)">←</button>
                <div class="shot-display">SHOT <span id="curr-num">1</span></div>
                <button class="nav-btn" onclick="movePointer(1)">→</button>
            </div>

            <div class="status-panel">
                <div id="live-rem-icons" class="rem-bullet-list"></div>
                <div id="blank-rem-icons" class="rem-bullet-list"></div>
                <div style="font-family: 'Bebas Neue'; font-size: 4rem; margin-top: 10px;">
                    SMOKE: <span id="live-prob" class="highlight">--</span><span id="prob-percent" style="color:#8b0000; font-size: 4rem; font-weight: bold;">%</span>
                </div>
            </div>

            <div class="footer-btns">
                <button class="footer-btn reset-btn" onclick="resetCurrentTrack()">Reset [X]</button>
                <button class="footer-btn" onclick="reload()">Reload [R]</button>
            </div>
        </div>
    </div>

    <script>
        let initLive = 0, initBlank = 0;
        let currentLive = 0, currentBlank = 0;
        let currentIndex = 0;
        let shellStates = [];

        function initSelectors() {
            const liveGrid = document.getElementById('live-selector');
            const blankGrid = document.getElementById('blank-selector');
            liveGrid.innerHTML = ''; blankGrid.innerHTML = '';

            for(let i=1; i<=8; i++) {
                const lBtn = document.createElement('div');
                lBtn.className = 'ammo-slot';
                lBtn.innerText = i;
                lBtn.onclick = () => selectAmmo('live', i);
                lBtn.id = `l-${i}`;
                liveGrid.appendChild(lBtn);

                const bBtn = document.createElement('div');
                bBtn.className = 'ammo-slot';
                bBtn.innerText = i;
                bBtn.onclick = () => selectAmmo('blank', i);
                bBtn.id = `b-${i}`;
                blankGrid.appendChild(bBtn);
            }
        }

        function selectAmmo(type, num) {
            if (type === 'live') {
                initLive = (initLive === num) ? 0 : num;
            } else {
                initBlank = (initBlank === num) ? 0 : num;
            }
            updateSelectorUI();
        }

        function updateSelectorUI() {
            for(let i=1; i<=8; i++) {
                const l = document.getElementById(`l-${i}`);
                const b = document.getElementById(`b-${i}`);
                l.className = (i <= initLive) ? 'ammo-slot live-selected' : 'ammo-slot';
                b.className = (i <= initBlank) ? 'ammo-slot blank-selected' : 'ammo-slot';
            }

            const startBtn = document.getElementById('start-btn');
            if (initLive > 0 && initBlank > 0) {
                startBtn.classList.remove('invalid');
            } else {
                startBtn.classList.add('invalid');
            }
        }

        function startCombat() {
            if (initLive === 0 || initBlank === 0) return;
            resetCurrentTrack(); // 初始化戰鬥數據
            document.getElementById('setup-stage').classList.remove('active');
            document.getElementById('combat-stage').classList.add('active');
            createShells();
        }

        // 新增：僅重置目前這局的子彈狀態，不退回首頁
        function resetCurrentTrack() {
            currentLive = initLive;
            currentBlank = initBlank;
            currentIndex = 0;
            shellStates = Array(initLive + initBlank).fill('unknown');
            updateShellVisuals();
            calculate();
        }

        function createShells() {
            const track = document.getElementById('shell-track');
            track.innerHTML = '';
            shellStates.forEach((state, i) => {
                const s = document.createElement('div');
                s.className = 'shell';
                s.innerText = i + 1;
                s.onclick = () => toggleShell(i);
                track.appendChild(s);
            });
            updateShellVisuals();
        }

        function toggleShell(idx) {
            const state = shellStates[idx];
            if (state === 'unknown') {
                if (currentLive > 0) { shellStates[idx] = 'live'; currentLive--; }
                else if (currentBlank > 0) { shellStates[idx] = 'blank'; currentBlank--; }
            } else if (state === 'live') {
                currentLive++;
                if (currentBlank > 0) { shellStates[idx] = 'blank'; currentBlank--; }
                else { shellStates[idx] = 'unknown'; }
            } else {
                currentBlank++;
                shellStates[idx] = 'unknown';
            }
            updateShellVisuals();
            calculate();
        }

        function updateShellVisuals() {
            const shells = document.querySelectorAll('.shell');
            shells.forEach((s, i) => {
                s.classList.remove('live', 'blank', 'current');
                if (shellStates[i] === 'live') s.classList.add('live');
                if (shellStates[i] === 'blank') s.classList.add('blank');
                if (i === currentIndex) s.classList.add('current');
            });
            
            const liveContainer = document.getElementById('live-rem-icons');
            const blankContainer = document.getElementById('blank-rem-icons');
            liveContainer.innerHTML = '';
            blankContainer.innerHTML = '';

            for(let i=0; i<currentLive; i++) {
                const b = document.createElement('div');
                b.className = 'bullet-sm live';
                liveContainer.appendChild(b);
            }
            for(let i=0; i<currentBlank; i++) {
                const b = document.createElement('div');
                b.className = 'bullet-sm blank';
                blankContainer.appendChild(b);
            }

            document.getElementById('curr-num').innerText = currentIndex + 1;
        }

        function movePointer(dir) {
            const total = initLive + initBlank;
            if(total === 0) return;
            currentIndex = (currentIndex + dir + total) % total;
            updateShellVisuals();
        }

        function calculate() {
            let totalRemaining = currentLive + currentBlank;
            document.getElementById('live-prob').innerText = totalRemaining === 0 ? "0" : Math.round((currentLive/totalRemaining)*100);
        }

        // 退回初始設定畫面
        function reload() {
            initLive = 0; initBlank = 0;
            initSelectors();
            document.getElementById('combat-stage').classList.remove('active');
            document.getElementById('setup-stage').classList.add('active');
        }

        document.addEventListener('keydown', (e) => {
            const key = e.key.toUpperCase();
            if (document.getElementById('setup-stage').classList.contains('active')) {
                if (key === 'ENTER') startCombat();
            } else {
                if (key === 'R') reload(); 
                if (key === 'X') resetCurrentTrack(); // 快速鍵 X 重置目前這局
                if (key === 'ARROWLEFT') movePointer(-1);
                if (key === 'ARROWRIGHT' || key === ' ') { e.preventDefault(); movePointer(1); }
            }
        });

        initSelectors();
    </script>
</body>
</html>
